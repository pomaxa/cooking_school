<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —à–∫–æ–ª–∞ - –∑–∞–ø–∏—Å—å –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã –ø–æ –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–π –ø–∞—Å—Ç–µ, —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–º –¥–µ—Å–µ—Ä—Ç–∞–º –∏ –¥—Ä—É–≥–∏–º –±–ª—é–¥–∞–º">
    <title>–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –®–∫–æ–ª–∞ | –ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏—è</title>

    <!-- Google Fonts - Premium Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Design System CSS -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/index.css">

    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Translations -->
    <script src="translations.js"></script>

    <!-- Page-specific styles are in styles/index.css -->
</head>
<body>
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="skip-link">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é</a>

    <div class="page-container">
        <header class="site-header" role="banner">
            <div class="header-controls">
                <nav class="lang-switcher" role="navigation" aria-label="Language selection">
                    <button class="lang-btn active" data-lang="ru" onclick="setLanguage('ru')" aria-label="Switch to Russian" aria-pressed="true">RU</button>
                    <button class="lang-btn" data-lang="lv" onclick="setLanguage('lv')" aria-label="Switch to Latvian" aria-pressed="false">LV</button>
                </nav>
            </div>
            <h1 class="site-title scroll-reveal" data-i18n="header_title">
                <svg class="icon-chef-hat" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-hidden="true">
                    <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/>
                    <line x1="6" y1="17" x2="18" y2="17"/>
                </svg>
                –ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –®–∫–æ–ª–∞
            </h1>
            <p class="site-subtitle scroll-reveal" data-i18n="header_subtitle">–ù–∞—É—á–∏—Ç–µ—Å—å –≥–æ—Ç–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª</p>
        </header>

        <main id="main-content" role="main">
            <div id="loadingMessage" class="loading-message" style="display: none;" role="status" aria-live="polite">
                <div class="loading-spinner" aria-hidden="true"></div>
                <p data-i18n="classes_loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–Ω—è—Ç–∏–π...</p>
            </div>

            <section class="classes-container" aria-label="Available cooking classes">
                <div class="classes-grid" id="classesGrid" role="list"></div>
            </section>
        </main>
    </div>

    <!-- My Bookings Button -->
    <button class="my-bookings-btn" onclick="showMyBookings()" aria-label="View my bookings">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/>
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"/>
            <line x1="9" y1="12" x2="15" y2="12"/>
            <line x1="9" y1="16" x2="15" y2="16"/>
        </svg>
        <span data-i18n="nav_bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</span>
    </button>

    <!-- Booking Modal -->
    <div class="modal-backdrop" id="bookingModal" style="display: none;" onclick="if(event.target === this) closeModal();" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle" data-i18n="booking_title">–ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close booking dialog">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="booking-summary" id="bookingSummary"></div>

                <form id="bookingForm">
                    <div class="form-group">
                        <label class="form-label form-label-required" data-i18n="payment_type_label">–¢–∏–ø –æ–ø–ª–∞—Ç—ã</label>
                    <div class="payment-type-options">
                        <label class="radio-option">
                            <input type="radio" name="paymentType" value="full" checked onchange="updateBookingSummary()">
                            <div class="radio-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                    <line x1="1" y1="10" x2="23" y2="10"/>
                                </svg>
                            </div>
                            <span>
                                <strong data-i18n="payment_full">–ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (100%)</strong>
                                <small data-i18n="payment_full_desc">–û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ–π—á–∞—Å</small>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="paymentType" value="partial" onchange="updateBookingSummary()">
                            <div class="radio-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 6v6l4 2"/>
                                    <path d="M16 16l-4-4"/>
                                </svg>
                            </div>
                            <span>
                                <strong data-i18n="payment_partial">–ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (10%)</strong>
                                <small data-i18n="payment_partial_desc">–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –º–µ—Å—Ç–∞ - –æ–ø–ª–∞—Ç–∏—Ç–µ 10% —Å–µ–π—á–∞—Å</small>
                            </span>
                        </label>
                    </div>
                </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="participants" data-i18n="booking_participants">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                        <select class="form-select" id="participants" required></select>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="name" data-i18n="booking_name">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è</label>
                        <input class="form-input" type="text" id="name" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="email" data-i18n="booking_email">Email</label>
                        <input class="form-input" type="email" id="email" required placeholder="ivan@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="phone" data-i18n="booking_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input class="form-input" type="tel" id="phone" required placeholder="+371 12345678">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="allergies" data-i18n="booking_allergies">–ê–ª–ª–µ—Ä–≥–∏–∏ –∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
                        <textarea class="form-textarea" id="allergies" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –∞–ª–ª–µ—Ä–≥–∏–∏ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–ª–∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="card-element" data-i18n="booking_card_label">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
                        <div id="card-element" style="padding: var(--space-3); border: 2px solid var(--color-border-medium); border-radius: var(--radius-lg);"></div>
                        <div id="card-errors" class="form-error-message"></div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary btn-lg btn-block" id="submitButton" data-i18n="booking_btn_pay">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                            <span>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</span>
                        </button>
                    </div>

                    <div id="successMessage" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration - will be loaded from server
        let API_URL;
        let STRIPE_PUBLIC_KEY;
        let stripe;
        let elements;
        let cardElement;
        let selectedClass = null;
        let classes = [];
        let clientSecret = null;

        // Focus trap variables
        let lastFocusedElement = null;
        let focusableElements = [];
        let firstFocusableElement = null;
        let lastFocusableElement = null;

        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                API_URL = window.location.origin + config.apiUrl;
                STRIPE_PUBLIC_KEY = config.stripePublicKey;

                // Initialize Stripe with fetched key
                stripe = Stripe(STRIPE_PUBLIC_KEY);
                elements = stripe.elements();

                return true;
            } catch (error) {
                console.error('Error loading configuration:', error);
                return false;
            }
        }

        // Load classes from API
        async function loadClasses() {
            try {
                // Show skeleton loading cards
                renderSkeletons();
                document.getElementById('loadingMessage').style.display = 'none';

                const response = await fetch(`${API_URL}/classes`);

                if (!response.ok) {
                    throw new Error('Failed to load classes');
                }

                classes = await response.json();

                // Replace skeletons with real data after a brief delay for smooth transition
                setTimeout(() => {
                    renderClasses();
                }, 300);
            } catch (error) {
                console.error('Error loading classes:', error);
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('loadingMessage').innerHTML = `
                    <div class="loading-error">
                        ${getIcon('close')}
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.</p>
                    </div>
                `;
            }
        }

        // SVG Icon helpers
        function getIcon(name) {
            const icons = {
                calendar: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
                clock: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                chef: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/></svg>',
                check: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
                close: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'
            };
            return icons[name] || '';
        }

        // Focus trap for modal accessibility
        function handleFocusTrap(e) {
            if (e.key !== 'Tab') return;

            if (e.shiftKey) {
                // Shift + Tab (backwards)
                if (document.activeElement === firstFocusableElement) {
                    e.preventDefault();
                    lastFocusableElement.focus();
                }
            } else {
                // Tab (forwards)
                if (document.activeElement === lastFocusableElement) {
                    e.preventDefault();
                    firstFocusableElement.focus();
                }
            }
        }

        function setupFocusTrap(modal) {
            // Get all focusable elements in modal
            const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
            focusableElements = modal.querySelectorAll(focusableSelectors);
            firstFocusableElement = focusableElements[0];
            lastFocusableElement = focusableElements[focusableElements.length - 1];

            // Add event listener for Tab key
            modal.addEventListener('keydown', handleFocusTrap);

            // Focus first element
            setTimeout(() => {
                if (firstFocusableElement) {
                    firstFocusableElement.focus();
                }
            }, 100);
        }

        function removeFocusTrap(modal) {
            modal.removeEventListener('keydown', handleFocusTrap);

            // Return focus to element that opened modal
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }

        // Render skeleton loading cards
        function renderSkeletons() {
            const grid = document.getElementById('classesGrid');
            const skeletonHTML = Array(6).fill(0).map((_, index) => `
                <div class="skeleton-class-card" style="animation-delay: ${index * 0.1}s;">
                    <div class="skeleton-header">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-price"></div>
                    </div>
                    <div class="skeleton-info">
                        <div class="skeleton-info-item"></div>
                        <div class="skeleton-info-item"></div>
                        <div class="skeleton-info-item"></div>
                    </div>
                    <div class="skeleton-description"></div>
                    <div class="skeleton-description" style="width: 80%;"></div>
                    <div class="skeleton-capacity">
                        <div class="skeleton-capacity-label"></div>
                        <div class="skeleton-capacity-bar"></div>
                    </div>
                    <div class="skeleton-button"></div>
                </div>
            `).join('');
            grid.innerHTML = skeletonHTML;
        }

        // Get hero image URL based on class ID
        function getHeroImage(classId, title) {
            // Mapping of class IDs to Unsplash image URLs
            const imageMap = {
                1: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=800&h=450&fit=crop&q=80', // Pasta
                2: 'https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=800&h=450&fit=crop&q=80', // Baking
                3: 'https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=800&h=450&fit=crop&q=80', // Sushi
                4: 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&h=450&fit=crop&q=80', // Desserts
                5: 'https://images.unsplash.com/photo-1556910103-1c02745aae4d?w=800&h=450&fit=crop&q=80', // Cooking basics
                6: 'https://images.unsplash.com/photo-1600565193348-f74bd3c7ccdf?w=800&h=450&fit=crop&q=80'  // Professional course
            };
            return imageMap[classId] || 'https://images.unsplash.com/photo-1556910103-1c02745aae4d?w=800&h=450&fit=crop&q=80';
        }

        // Render classes
        function renderClasses() {
            const grid = document.getElementById('classesGrid');
            const currentLang = window.currentLang || 'ru';

            grid.innerHTML = classes.map(cls => {
                const availableSpots = cls.capacity - cls.booked;
                const isFull = availableSpots <= 0;
                const percentage = (cls.booked / cls.capacity) * 100;

                // Get localized fields
                const title = typeof cls.title === 'object' ? cls.title[currentLang] || cls.title.ru : cls.title;
                const description = typeof cls.description === 'object' ? cls.description[currentLang] || cls.description.ru : cls.description;
                const instructor = typeof cls.instructor === 'object' ? cls.instructor[currentLang] || cls.instructor.ru : cls.instructor;

                // Audience type badge
                let audienceBadge = '';
                if (cls.audienceType) {
                    switch (cls.audienceType) {
                        case 'adults':
                            audienceBadge = '<span class="badge badge-primary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üë• –î–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö</span>';
                            break;
                        case 'kids':
                            audienceBadge = '<span class="badge badge-success" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üë∂ –î–ª—è –¥–µ—Ç–µ–π</span>';
                            break;
                        case 'mixed':
                            audienceBadge = '<span class="badge badge-gradient" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –î–ª—è –≤—Å–µ—Ö</span>';
                            break;
                    }
                }

                return `
                    <article class="class-card scroll-reveal" role="listitem" aria-label="${title} cooking class, ${availableSpots} spots available">
                        <div class="class-card-image">
                            <img src="${getHeroImage(cls.id, title)}" alt="${title}" loading="lazy">
                        </div>
                        <div class="class-card-content">
                        <div class="class-card-header">
                            <div style="flex: 1;">
                                <h3 class="class-card-title">${title}</h3>
                                ${audienceBadge}
                            </div>
                            <div class="class-card-price" aria-label="Price: ${cls.price} euros">‚Ç¨${cls.price}</div>
                        </div>

                        <div class="class-card-info">
                            <div class="class-info-item">
                                <span class="class-info-icon" aria-hidden="true">${getIcon('calendar')}</span>
                                <span><time datetime="${cls.date}">${formatDate(cls.date)}</time></span>
                            </div>
                            <div class="class-info-item">
                                <span class="class-info-icon" aria-hidden="true">${getIcon('clock')}</span>
                                <span>${cls.time} (${cls.duration})</span>
                            </div>
                            <div class="class-info-item">
                                <span class="class-info-icon" aria-hidden="true">${getIcon('chef')}</span>
                                <span>${instructor}</span>
                            </div>
                        </div>

                        <div class="class-card-description">${description}</div>

                        <div class="capacity-container" aria-label="Capacity: ${availableSpots} of ${cls.capacity} spots available">
                            <div class="capacity-label">
                                <span data-i18n="class_available">${t('class_available')}</span>
                                <span><strong>${availableSpots}</strong> ${t('class_capacity')} ${cls.capacity}</span>
                            </div>
                            <div class="capacity-bar" role="progressbar" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100" aria-label="${percentage}% booked">
                                <div class="capacity-fill ${isFull ? 'full' : ''}"
                                     style="width: ${percentage}%"></div>
                            </div>
                        </div>

                        <div class="class-card-actions">
                            <button class="btn-book"
                                    onclick="openBookingModal(${cls.id})"
                                    aria-label="${isFull ? 'Class is full' : 'Book ' + title}"
                                    ${isFull ? 'disabled aria-disabled="true"' : ''}>
                                <span aria-hidden="true">${isFull ? getIcon('close') : getIcon('check')}</span>
                                <span>${isFull ? t('class_full') : t('class_book')}</span>
                            </button>
                        </div>
                        </div>
                    </article>
                `;
            }).join('');

            // Initialize scroll animations after rendering
            setTimeout(() => initScrollAnimations(), 100);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const currentLang = window.currentLang || 'ru';
            const locale = currentLang === 'lv' ? 'lv-LV' : 'ru-RU';
            return date.toLocaleDateString(locale, options);
        }

        async function openBookingModal(classId) {
            // Store currently focused element
            lastFocusedElement = document.activeElement;

            selectedClass = classes.find(c => c.id === classId);
            const modal = document.getElementById('bookingModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent body scroll

            // Update summary
            updateBookingSummary();

            // Setup participants dropdown
            const participantsSelect = document.getElementById('participants');
            const availableSpots = selectedClass.capacity - selectedClass.booked;
            participantsSelect.innerHTML = '';
            for (let i = 1; i <= availableSpots; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                participantsSelect.appendChild(option);
            }

            // Load saved customer data from localStorage
            loadCustomerData();

            // Setup Stripe card element if not already done
            if (!cardElement) {
                cardElement = elements.create('card', {
                    hidePostalCode: true,
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                });
                cardElement.mount('#card-element');

                cardElement.on('change', (event) => {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            }

            // Update summary when participants change
            participantsSelect.addEventListener('change', updateBookingSummary);

            // Setup form validation
            setupFormValidation();

            // Setup focus trap for accessibility
            setupFocusTrap(modal);
        }

        // Form Validation
        function setupFormValidation() {
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');

            // Name validation
            nameInput.addEventListener('blur', () => validateName(nameInput));
            nameInput.addEventListener('input', () => {
                if (nameInput.classList.contains('form-input-error')) {
                    validateName(nameInput);
                }
            });

            // Email validation
            emailInput.addEventListener('blur', () => validateEmail(emailInput));
            emailInput.addEventListener('input', () => {
                if (emailInput.classList.contains('form-input-error')) {
                    validateEmail(emailInput);
                }
            });

            // Phone validation
            phoneInput.addEventListener('blur', () => validatePhone(phoneInput));
            phoneInput.addEventListener('input', () => {
                if (phoneInput.classList.contains('form-input-error')) {
                    validatePhone(phoneInput);
                }
            });
        }

        function validateName(input) {
            const value = input.value.trim();
            const errorId = 'name-error';
            let existingError = document.getElementById(errorId);

            if (value.length < 2) {
                input.classList.add('form-input-error');
                if (!existingError) {
                    const errorMsg = document.createElement('div');
                    errorMsg.id = errorId;
                    errorMsg.className = 'form-error-message';
                    errorMsg.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>${t('validation_name') || '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é'}</span>
                    `;
                    input.parentNode.appendChild(errorMsg);
                }
                return false;
            } else {
                input.classList.remove('form-input-error');
                if (existingError) existingError.remove();
                return true;
            }
        }

        function validateEmail(input) {
            const value = input.value.trim();
            const errorId = 'email-error';
            let existingError = document.getElementById(errorId);
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(value)) {
                input.classList.add('form-input-error');
                if (!existingError) {
                    const errorMsg = document.createElement('div');
                    errorMsg.id = errorId;
                    errorMsg.className = 'form-error-message';
                    errorMsg.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>${t('validation_email') || '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'}</span>
                    `;
                    input.parentNode.appendChild(errorMsg);
                }
                return false;
            } else {
                input.classList.remove('form-input-error');
                if (existingError) existingError.remove();
                return true;
            }
        }

        function validatePhone(input) {
            const value = input.value.trim();
            const errorId = 'phone-error';
            let existingError = document.getElementById(errorId);
            const phoneRegex = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;

            if (!phoneRegex.test(value) || value.length < 8) {
                input.classList.add('form-input-error');
                if (!existingError) {
                    const errorMsg = document.createElement('div');
                    errorMsg.id = errorId;
                    errorMsg.className = 'form-error-message';
                    errorMsg.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>${t('validation_phone') || '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω'}</span>
                    `;
                    input.parentNode.appendChild(errorMsg);
                }
                return false;
            } else {
                input.classList.remove('form-input-error');
                if (existingError) existingError.remove();
                return true;
            }
        }

        function updateBookingSummary() {
            if (!selectedClass) return;

            const participants = parseInt(document.getElementById('participants').value) || 1;
            const paymentType = document.querySelector('input[name="paymentType"]:checked')?.value || 'full';
            const total = selectedClass.price * participants;
            const paymentAmount = paymentType === 'partial' ? Math.round(total * 0.1 * 100) / 100 : total;
            const currentLang = window.currentLang || 'ru';

            // Get localized title
            const title = typeof selectedClass.title === 'object'
                ? selectedClass.title[currentLang] || selectedClass.title.ru
                : selectedClass.title;

            let paymentDetails = '';
            if (paymentType === 'partial') {
                const remaining = total - paymentAmount;
                paymentDetails = `
                    <div class="booking-summary-item">
                        <span data-i18n="payment_deposit">${t('payment_deposit')} (10%):</span>
                        <span>‚Ç¨${paymentAmount.toFixed(2)}</span>
                    </div>
                    <div class="booking-summary-item">
                        <span data-i18n="payment_remaining">${t('payment_remaining')}:</span>
                        <span>‚Ç¨${remaining.toFixed(2)}</span>
                    </div>
                `;
            }

            document.getElementById('bookingSummary').innerHTML = `
                <div class="booking-summary-item">
                    <span data-i18n="booking_class">${t('booking_class')}:</span>
                    <span><strong>${title}</strong></span>
                </div>
                <div class="booking-summary-item">
                    <span data-i18n="booking_date">${t('booking_date')}:</span>
                    <span>${formatDate(selectedClass.date)} ${t('booking_time')} ${selectedClass.time}</span>
                </div>
                <div class="booking-summary-item">
                    <span data-i18n="booking_participants">${t('booking_participants')}:</span>
                    <span>${participants} √ó ‚Ç¨${selectedClass.price}</span>
                </div>
                <div class="booking-summary-item">
                    <span data-i18n="payment_total_cost">${t('payment_total_cost')}:</span>
                    <span>‚Ç¨${total.toFixed(2)}</span>
                </div>
                ${paymentDetails}
                <div class="booking-summary-item booking-summary-total">
                    <span data-i18n="booking_total">${t('booking_total')}:</span>
                    <span>‚Ç¨${paymentAmount.toFixed(2)}</span>
                </div>
            `;
        }

        // Load customer data from localStorage
        function loadCustomerData() {
            const savedData = localStorage.getItem('customerData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.name) document.getElementById('name').value = data.name;
                    if (data.email) document.getElementById('email').value = data.email;
                    if (data.phone) document.getElementById('phone').value = data.phone;
                    if (data.allergies) document.getElementById('allergies').value = data.allergies;
                } catch (e) {
                    console.error('Error loading customer data:', e);
                }
            }
        }

        // Save customer data to localStorage
        function saveCustomerData(name, email, phone, allergies = '') {
            try {
                const data = { name, email, phone, allergies };
                localStorage.setItem('customerData', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving customer data:', e);
            }
        }

        function closeModal() {
            const modal = document.getElementById('bookingModal');

            // Remove focus trap and restore focus
            removeFocusTrap(modal);

            modal.style.display = 'none';
            document.getElementById('bookingForm').reset();
            document.getElementById('successMessage').style.display = 'none';
            document.body.style.overflow = ''; // Restore body scroll
            clientSecret = null;
        }

        // Keyboard navigation - close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('bookingModal');
                if (modal.style.display === 'flex') {
                    closeModal();
                }
            }
        });

        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate all fields before submission
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');

            const isNameValid = validateName(nameInput);
            const isEmailValid = validateEmail(emailInput);
            const isPhoneValid = validatePhone(phoneInput);

            if (!isNameValid || !isEmailValid || !isPhoneValid) {
                // Scroll to first error
                const firstError = document.querySelector('.form-input-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            const originalButtonContent = submitButton.innerHTML;
            submitButton.innerHTML = `
                <svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M12 2 A 10 10 0 0 1 22 12" opacity="0.75"/>
                </svg>
                <span>–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
            `;

            const name = nameInput.value;
            const email = emailInput.value;
            const phone = phoneInput.value;
            const allergies = document.getElementById('allergies').value;
            const participants = parseInt(document.getElementById('participants').value);
            const paymentType = document.querySelector('input[name="paymentType"]:checked').value;

            try {
                // Step 1: Create Payment Intent
                if (!clientSecret) {
                    const response = await fetch(`${API_URL}/create-payment-intent`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            classId: selectedClass.id,
                            participants: participants,
                            email: email,
                            name: name,
                            paymentType: paymentType
                        }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to create payment');
                    }

                    const data = await response.json();
                    clientSecret = data.clientSecret;
                }

                // Step 2: Confirm payment with Stripe
                const { paymentIntent, error: stripeError } = await stripe.confirmCardPayment(
                    clientSecret,
                    {
                        payment_method: {
                            card: cardElement,
                            billing_details: {
                                name: name,
                                email: email,
                                phone: phone,
                            },
                        },
                    }
                );

                if (stripeError) {
                    throw new Error(stripeError.message);
                }

                // Step 3: Confirm booking on server
                const confirmResponse = await fetch(`${API_URL}/confirm-booking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentIntentId: paymentIntent.id,
                        classId: selectedClass.id,
                        name: name,
                        email: email,
                        phone: phone,
                        participants: participants,
                        paymentType: paymentType
                    }),
                });

                if (!confirmResponse.ok) {
                    const error = await confirmResponse.json();
                    throw new Error(error.error || 'Failed to confirm booking');
                }

                const booking = await confirmResponse.json();

                // Save customer data to localStorage for future bookings
                saveCustomerData(name, email, phone, allergies);

                // Update local classes data
                await loadClasses();

                // Show success message
                document.getElementById('successMessage').innerHTML = `
                    <div class="success-message">
                        <div class="success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" fill="var(--color-success)" stroke="var(--color-success)"/>
                                <polyline points="8 12 11 15 16 9" stroke="white" stroke-width="3"/>
                            </svg>
                        </div>
                        <h3>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</h3>
                        <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, ${name}!</p>
                        <p>–í—ã –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ "${selectedClass.title}"</p>
                        <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${participants}</p>
                        <p>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ${email}</p>
                        <p style="margin-top: 15px; font-size: 0.9em;">ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: #${booking.booking.id}</p>
                    </div>
                `;
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('bookingForm').style.display = 'none';

                // Close modal after 4 seconds
                setTimeout(() => {
                    closeModal();
                    document.getElementById('bookingForm').style.display = 'block';
                }, 4000);

            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('card-errors').textContent = error.message;
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        });

        // Show user's bookings
        async function showMyBookings() {
            // Try to get saved email from localStorage
            let savedEmail = '';
            const savedData = localStorage.getItem('customerData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    savedEmail = data.email || '';
                } catch (e) {
                    console.error('Error loading saved email:', e);
                }
            }

            const email = prompt(t('mybookings_enter_email'), savedEmail);
            if (!email) return;

            try {
                const response = await fetch(`${API_URL}/bookings/email/${encodeURIComponent(email)}`);
                if (!response.ok) {
                    throw new Error('Failed to load bookings');
                }

                const bookings = await response.json();
                
                if (bookings.length === 0) {
                    alert('–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
                    return;
                }

                let message = '–í–∞—à–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:\n\n';
                bookings.forEach(b => {
                    message += `#${b.id} - ${b.className}\n`;
                    message += `–î–∞—Ç–∞: ${formatDate(b.date)} –≤ ${b.time}\n`;
                    message += `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${b.participants}\n`;
                    message += `–°—Ç–∞—Ç—É—Å: ${b.status === 'confirmed' ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ ‚úì' : '–û—Ç–º–µ–Ω–µ–Ω–æ ‚úó'}\n\n`;
                });

                alert(message);
            } catch (error) {
                console.error('Error loading bookings:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
            }
        }

        // Listen for language change events
        document.addEventListener('languageChanged', () => {
            renderClasses();
        });

        // Intersection Observer for scroll animations
        function initScrollAnimations() {
            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -100px 0px', // Trigger slightly before element enters viewport
                threshold: 0.1
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        // Optional: stop observing after animation
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            // Observe all scroll-reveal elements
            document.querySelectorAll('.scroll-reveal').forEach(el => {
                observer.observe(el);
            });
        }

        // Initialize app - load config first, then classes
        (async function init() {

            // Initialize scroll animations for header immediately
            initScrollAnimations();

            const configLoaded = await loadConfig();
            if (configLoaded) {
                loadClasses();
            } else {
                document.getElementById('loadingMessage').innerHTML = '<p style="color: red;">Error: Could not load configuration. Please refresh the page.</p>';
            }
        })();
    </script>
</body>
</html>
