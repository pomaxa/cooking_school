<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —à–∫–æ–ª–∞ - –∑–∞–ø–∏—Å—å –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã –ø–æ –∏—Ç–∞–ª—å—è–Ω—Å–∫–æ–π –ø–∞—Å—Ç–µ, —Ñ—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–º –¥–µ—Å–µ—Ä—Ç–∞–º –∏ –¥—Ä—É–≥–∏–º –±–ª—é–¥–∞–º">
    <title>–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –®–∫–æ–ª–∞ | –ì–ª–∞–≤–Ω–∞—è</title>

    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Translations -->
    <script src="translations.js"></script>

    <!-- Design System CSS -->
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/animations.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/index.css">

    <style>
        /* Payment Toggle Styles */
        .payment-type-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .payment-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }

        .payment-toggle-labels {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
            flex: 1;
        }

        .payment-toggle-title {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        .payment-toggle-description {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
            line-height: 1.3;
        }

        /* Toggle Switch Styles */
        .payment-toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
            flex-shrink: 0;
        }

        .payment-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .payment-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--color-bg-tertiary);
            transition: all var(--transition-base);
            border-radius: 28px;
            border: 2px solid var(--color-border-medium);
        }

        .payment-toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: all var(--transition-base);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .payment-toggle-switch input:checked + .payment-toggle-slider {
            background: var(--gradient-primary);
            border-color: var(--color-primary-600);
        }

        .payment-toggle-switch input:checked + .payment-toggle-slider:before {
            transform: translateX(24px);
        }

        .payment-toggle-switch:hover .payment-toggle-slider {
            border-color: var(--color-primary-500);
        }

        /* Active state labels */
        .payment-toggle-container[data-active="full"] .payment-toggle-labels[data-type="full"] .payment-toggle-title,
        .payment-toggle-container[data-active="partial"] .payment-toggle-labels[data-type="partial"] .payment-toggle-title {
            color: var(--color-primary-600);
            font-weight: var(--font-weight-semibold);
        }

        /* Home Page Specific Styles */
        body {
            background: #FFF8F0;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Sticky Header */
        .home-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .home-header-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .home-header-left {
            display: flex;
            flex-direction: column;
        }

        .home-title-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .home-title-row .emoji {
            font-size: 2rem;
        }

        .home-title-row h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            color: var(--color-text-primary);
        }

        .home-subtitle {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin: 0;
            margin-left: 2.5rem;
        }

        .home-header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lang-toggle {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 0.25rem;
        }

        .lang-toggle-btn {
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-base);
            font-size: 0.875rem;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: var(--font-weight-medium);
        }

        .lang-toggle-btn.active {
            background: white;
            color: var(--color-text-primary);
            box-shadow: var(--shadow-sm);
        }

        .lang-toggle-btn:hover:not(.active) {
            color: var(--color-text-primary);
        }

        .bookings-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--color-border-medium);
            border-radius: var(--radius-base);
            background: white;
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.875rem;
        }

        .bookings-btn:hover {
            background: var(--color-bg-secondary);
        }

        .bookings-btn svg {
            width: 16px;
            height: 16px;
        }

        .bookings-btn-text {
            display: none;
        }

        /* Classes Section */
        .classes-section {
            padding: 3rem 1rem;
        }

        .classes-container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .classes-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        /* Class Card */
        .class-card {
            background: white;
            border-radius: var(--radius-2xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: box-shadow var(--transition-base);
        }

        .class-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .class-card-image-wrapper {
            position: relative;
            aspect-ratio: 16 / 9;
            overflow: hidden;
        }

        .class-card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-slow);
        }

        .class-card:hover .class-card-image {
            transform: scale(1.05);
        }

        .class-card-body {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .class-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0;
        }

        .class-card-price {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--color-primary-600);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .class-card-price svg {
            width: 20px;
            height: 20px;
            fill: var(--color-primary-600);
        }

        .class-card-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }

        .class-card-meta svg {
            width: 16px;
            height: 16px;
        }

        .class-card-description {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .class-card-seats {
            padding-top: 0.5rem;
            border-top: 1px solid var(--color-border-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .class-card-seats svg {
            width: 16px;
            height: 16px;
        }

        .class-card-seats.low-seats {
            color: var(--color-error);
        }

        .class-card-footer {
            padding: 0 1rem 1rem;
        }

        .class-card-book-btn {
            width: 100%;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-base);
            background: var(--color-primary-600);
            color: white;
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .class-card-book-btn:hover {
            background: var(--color-primary-700);
        }

        .class-card-book-btn:disabled {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
            cursor: not-allowed;
        }

        /* Modal Overrides - Ensure visibility */
        .modal-backdrop {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-backdrop[style*="display: flex"] {
            display: flex !important;
        }

        .modal-backdrop .modal {
            opacity: 1 !important;
            transform: scale(1) !important;
            animation: none !important;
            z-index: 10000 !important;
        }

        /* Responsive */
        @media (min-width: 640px) {
            .bookings-btn-text {
                display: inline;
            }
        }

        @media (min-width: 768px) {
            .classes-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .home-title-row h1 {
                font-size: 2rem;
            }

            .home-title-row .emoji {
                font-size: 2.5rem;
            }
        }

        @media (min-width: 1024px) {
            .classes-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="home-header">
        <div class="home-header-container">
            <div class="home-header-left">
                <div class="home-title-row">
                    <span class="emoji">üç≥</span>
                    <h1 id="headerTitle" data-i18n="header_title">–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è —à–∫–æ–ª–∞</h1>
                </div>
                <p class="home-subtitle" id="headerSubtitle" data-i18n="header_subtitle">–ù–∞—É—á–∏—Ç–µ—Å—å –≥–æ—Ç–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª</p>
            </div>
            <div class="home-header-right">
                <div class="lang-toggle">
                    <button class="lang-toggle-btn active" id="langRu" data-lang="ru" onclick="setLanguage('ru')">RU</button>
                    <button class="lang-toggle-btn" id="langLv" data-lang="lv" onclick="setLanguage('lv')">LV</button>
                </div>
                <button class="bookings-btn" id="myBookingsBtn" onclick="showMyBookings()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                        <line x1="16" x2="16" y1="2" y2="6"/>
                        <line x1="8" x2="8" y1="2" y2="6"/>
                        <line x1="3" x2="21" y1="10" y2="10"/>
                    </svg>
                    <span class="bookings-btn-text" data-i18n="nav_bookings">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Classes Grid -->
    <section class="classes-section">
        <div class="classes-container">
            <div class="classes-grid" id="classesGrid">
                <!-- Cards will be rendered here -->
            </div>
        </div>
    </section>

    <!-- Booking Modal -->
    <div class="modal-backdrop" id="bookingModal" style="display: none;" onclick="if(event.target === this) closeModal();" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle" data-i18n="booking_title">–ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close booking dialog">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="booking-summary" id="bookingSummary"></div>

                <form id="bookingForm">
                    <div class="form-group">
                        <label class="form-label form-label-required" data-i18n="payment_type_label">–¢–∏–ø –æ–ø–ª–∞—Ç—ã</label>
                    <div class="payment-type-options">
                        <div class="payment-toggle-container" id="paymentToggleContainer" data-active="full">
                            <div class="payment-toggle-labels" data-type="full">
                                <div class="payment-toggle-title" data-i18n="payment_full">–ü–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (100%)</div>
                                <div class="payment-toggle-description" data-i18n="payment_full_desc">–û–ø–ª–∞—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ–π—á–∞—Å</div>
                            </div>

                            <label class="payment-toggle-switch">
                                <input type="checkbox" id="paymentToggle" onchange="togglePaymentType()">
                                <span class="payment-toggle-slider"></span>
                            </label>

                            <div class="payment-toggle-labels" data-type="partial">
                                <div class="payment-toggle-title" data-i18n="payment_partial">–ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (10%)</div>
                                <div class="payment-toggle-description" data-i18n="payment_partial_desc">–†–µ–∑–µ—Ä–≤–∞—Ü–∏—è –º–µ—Å—Ç–∞ - 10% —Å–µ–π—á–∞—Å</div>
                            </div>
                        </div>

                        <input type="hidden" name="paymentType" id="paymentType" value="full">
                    </div>
                </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="participants" data-i18n="booking_participants">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                        <select class="form-select" id="participants" required></select>
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="name" data-i18n="booking_name">–ò–º—è –∏ –§–∞–º–∏–ª–∏—è</label>
                        <input class="form-input" type="text" id="name" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="email" data-i18n="booking_email">Email</label>
                        <input class="form-input" type="email" id="email" required placeholder="ivan@example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label form-label-required" for="phone" data-i18n="booking_phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input class="form-input" type="tel" id="phone" required placeholder="+371 12345678">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="allergies" data-i18n="booking_allergies">–ê–ª–ª–µ—Ä–≥–∏–∏ –∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
                        <textarea class="form-textarea" id="allergies" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –∞–ª–ª–µ—Ä–≥–∏–∏ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–ª–∏ –æ—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="card-element" data-i18n="booking_card_label">–î–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã</label>
                        <div id="card-element" style="padding: var(--space-3); border: 2px solid var(--color-border-medium); border-radius: var(--radius-lg);"></div>
                        <div id="card-errors" class="form-error-message"></div>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary btn-lg btn-block" id="submitButton" data-i18n="booking_btn_pay">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                            <span>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å</span>
                        </button>
                    </div>

                    <div id="successMessage" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let API_URL;
        let STRIPE_PUBLIC_KEY;
        let stripe;
        let elements;
        let cardElement;
        let selectedClass = null;
        let classes = [];
        let clientSecret = null;
        let lastFocusedElement = null;
        let focusableElements = [];
        let firstFocusableElement = null;
        let lastFocusableElement = null;

        async function loadConfig() {
            try {
                const response = await fetch('/config');
                const config = await response.json();
                API_URL = window.location.origin + config.apiUrl;
                STRIPE_PUBLIC_KEY = config.stripePublicKey;

                stripe = Stripe(STRIPE_PUBLIC_KEY);
                elements = stripe.elements();

                return true;
            } catch (error) {
                console.error('Error loading configuration:', error);
                return false;
            }
        }

        async function loadClasses() {
            try {
                renderSkeletons();

                const response = await fetch(`${API_URL}/classes`);

                if (!response.ok) {
                    throw new Error('Failed to load classes');
                }

                classes = await response.json();

                setTimeout(() => {
                    renderClasses();
                }, 300);
            } catch (error) {
                console.error('Error loading classes:', error);
                const grid = document.getElementById('classesGrid');
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                        <p style="color: var(--color-error);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.</p>
                    </div>
                `;
            }
        }

        function renderSkeletons() {
            const grid = document.getElementById('classesGrid');
            const skeletonHTML = Array(6).fill(0).map((_, index) => `
                <div class="skeleton-class-card" style="animation-delay: ${index * 0.1}s;">
                    <div class="skeleton-header">
                        <div class="skeleton-title"></div>
                        <div class="skeleton-price"></div>
                    </div>
                    <div class="skeleton-info">
                        <div class="skeleton-info-item"></div>
                        <div class="skeleton-info-item"></div>
                        <div class="skeleton-info-item"></div>
                    </div>
                    <div class="skeleton-description"></div>
                    <div class="skeleton-description" style="width: 80%;"></div>
                    <div class="skeleton-capacity">
                        <div class="skeleton-capacity-label"></div>
                        <div class="skeleton-capacity-bar"></div>
                    </div>
                    <div class="skeleton-button"></div>
                </div>
            `).join('');
            grid.innerHTML = skeletonHTML;
        }

        function renderClasses() {
            const grid = document.getElementById('classesGrid');
            const currentLang = window.currentLang || 'ru';

            grid.innerHTML = classes.map(cls => {
                const availableSpots = cls.capacity - cls.booked;
                const isFull = availableSpots <= 0;
                const lowSeats = availableSpots <= 3;

                const title = typeof cls.title === 'object' ? cls.title[currentLang] || cls.title.ru : cls.title;
                const description = typeof cls.description === 'object' ? cls.description[currentLang] || cls.description.ru : cls.description;
                const instructor = typeof cls.instructor === 'object' ? cls.instructor[currentLang] || cls.instructor.ru : cls.instructor;

                return `
                    <div class="class-card">
                        <div class="class-card-image-wrapper">
                            <img src="${getHeroImage(cls.id, title)}" alt="${title}" class="class-card-image" loading="lazy">
                        </div>
                        <div class="class-card-body">
                            <h3 class="class-card-title">${title}</h3>
                            <div class="class-card-price">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M18.5 7h-1.7c-.8-1.2-2.1-2-3.8-2-2.8 0-5 2.2-5 5v1H6v2h2v1c0 2.8 2.2 5 5 5 1.7 0 3-.8 3.8-2h1.7v-2h-1.1c.1-.3.1-.7.1-1v-1h1v-2h-1v-.3c0-.3 0-.5-.1-.7h1.1V7zm-5 10c-1.7 0-3-1.3-3-3v-1h6v1c0 1.7-1.3 3-3 3zm0-6c-1.7 0-3-1.3-3-3 0-1.7 1.3-3 3-3s3 1.3 3 3v1h-6v1c0 .3 0 .7.1 1h5.9c0-.3.1-.7.1-1v-1h-3z"/>
                                </svg>
                                ${cls.price}
                            </div>
                            <div class="class-card-meta">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                                    <line x1="16" x2="16" y1="2" y2="6"/>
                                    <line x1="8" x2="8" y1="2" y2="6"/>
                                    <line x1="3" x2="21" y1="10" y2="10"/>
                                </svg>
                                <span>${formatDate(cls.date)}</span>
                            </div>
                            <div class="class-card-meta">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <span>${cls.time} ‚Ä¢ ${cls.duration}</span>
                            </div>
                            <div class="class-card-meta">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/>
                                    <line x1="6" x2="18" y1="17" y2="17"/>
                                </svg>
                                <span>${instructor}</span>
                            </div>
                            <p class="class-card-description">${description}</p>
                            <div class="class-card-seats ${lowSeats ? 'low-seats' : ''}">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                                <span>${t('class_available')} ${availableSpots} ${t('class_capacity')} ${cls.capacity}</span>
                            </div>
                        </div>
                        <div class="class-card-footer">
                            <button class="class-card-book-btn" onclick="openBookingModal(${cls.id})" ${isFull ? 'disabled' : ''}>
                                ${isFull ? t('class_full') : t('class_book')}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            setTimeout(() => initScrollAnimations(), 100);
        }

        function getHeroImage(classId, title) {
            const imageMap = {
                1: 'https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=800&h=450&fit=crop&q=80',
                2: 'https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=800&h=450&fit=crop&q=80',
                3: 'https://images.unsplash.com/photo-1579584425555-c3ce17fd4351?w=800&h=450&fit=crop&q=80',
                4: 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&h=450&fit=crop&q=80',
                5: 'https://images.unsplash.com/photo-1556910103-1c02745aae4d?w=800&h=450&fit=crop&q=80',
                6: 'https://images.unsplash.com/photo-1600565193348-f74bd3c7ccdf?w=800&h=450&fit=crop&q=80'
            };
            return imageMap[classId] || 'https://images.unsplash.com/photo-1556910103-1c02745aae4d?w=800&h=450&fit=crop&q=80';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const currentLang = window.currentLang || 'ru';
            const locale = currentLang === 'lv' ? 'lv-LV' : 'ru-RU';
            return date.toLocaleDateString(locale, options);
        }

        function getAudienceBadge(audienceType) {
            switch (audienceType) {
                case 'adults':
                    return '<span class="badge badge-primary">–î–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö</span>';
                case 'kids':
                    return '<span class="badge badge-success">–î–ª—è –¥–µ—Ç–µ–π</span>';
                case 'mixed':
                    return '<span class="badge badge-gradient">–î–ª—è –≤—Å–µ—Ö</span>';
                default:
                    return '';
            }
        }

        function getIcon(name) {
            const icons = {
                calendar: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
                clock: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
                chef: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/></svg>',
                check: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
                close: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>'
            };
            return icons[name] || '';
        }

        async function openBookingModal(classId) {
            lastFocusedElement = document.activeElement;

            selectedClass = classes.find(c => c.id === classId);
            const modal = document.getElementById('bookingModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';

            updateBookingSummary();

            const participantsSelect = document.getElementById('participants');
            const availableSpots = selectedClass.capacity - selectedClass.booked;
            participantsSelect.innerHTML = '';
            for (let i = 1; i <= availableSpots; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                participantsSelect.appendChild(option);
            }

            loadCustomerData();

            if (!cardElement) {
                cardElement = elements.create('card', {
                    hidePostalCode: true,
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                    },
                });
                cardElement.mount('#card-element');

                cardElement.on('change', (event) => {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            }

            participantsSelect.addEventListener('change', updateBookingSummary);

            setupFormValidation();

            setupFocusTrap(modal);
        }

        function closeModal() {
            const modal = document.getElementById('bookingModal');

            removeFocusTrap(modal);

            modal.style.display = 'none';
            document.getElementById('bookingForm').reset();
            document.getElementById('successMessage').style.display = 'none';
            document.body.style.overflow = '';
            clientSecret = null;
        }

        function togglePaymentType() {
            const toggle = document.getElementById('paymentToggle');
            const container = document.getElementById('paymentToggleContainer');
            const hiddenInput = document.getElementById('paymentType');

            if (toggle.checked) {
                hiddenInput.value = 'partial';
                container.setAttribute('data-active', 'partial');
            } else {
                hiddenInput.value = 'full';
                container.setAttribute('data-active', 'full');
            }

            updateBookingSummary();
        }

        function updateBookingSummary() {
            if (!selectedClass) return;

            const participants = parseInt(document.getElementById('participants').value) || 1;
            const paymentType = document.getElementById('paymentType')?.value || 'full';
            const total = selectedClass.price * participants;
            const paymentAmount = paymentType === 'partial' ? Math.round(total * 0.1 * 100) / 100 : total;
            const currentLang = window.currentLang || 'ru';

            const title = typeof selectedClass.title === 'object'
                ? selectedClass.title[currentLang] || selectedClass.title.ru
                : selectedClass.title;

            let paymentDetails = '';
            if (paymentType === 'partial') {
                const remaining = total - paymentAmount;
                paymentDetails = `
                    <div class="booking-summary-item">
                        <span data-i18n="payment_deposit">${t('payment_deposit')} (10%):</span>
                        <span>‚Ç¨${paymentAmount.toFixed(2)}</span>
                    </div>
                    <div class="booking-summary-item">
                        <span data-i18n="payment_remaining">${t('payment_remaining')}:</span>
                        <span>‚Ç¨${remaining.toFixed(2)}</span>
                    </div>
                `;
            }

            document.getElementById('bookingSummary').innerHTML = `
                <div class="booking-summary-item">
                    <span data-i18n="booking_class">${t('booking_class')}:</span>
                    <span><strong>${title}</strong></span>
                </div>
                <div class="booking-summary-item">
                    <span data-i18n="booking_date">${t('booking_date')}:</span>
                    <span>${formatDate(selectedClass.date)} ${t('booking_time')} ${selectedClass.time}</span>
                </div>
                <div class="booking-summary-item">
                    <span data-i18n="booking_participants">${t('booking_participants')}:</span>
                    <span>${participants} √ó ‚Ç¨${selectedClass.price}</span>
                </div>
                <div class="booking-summary-item">
                    <span data-i18n="payment_total_cost">${t('payment_total_cost')}:</span>
                    <span>‚Ç¨${total.toFixed(2)}</span>
                </div>
                ${paymentDetails}
                <div class="booking-summary-item booking-summary-total">
                    <span data-i18n="booking_total">${t('booking_total')}:</span>
                    <span>‚Ç¨${paymentAmount.toFixed(2)}</span>
                </div>
            `;
        }

        function validateName(input) {
            const value = input.value.trim();
            const errorId = 'name-error';
            let existingError = document.getElementById(errorId);

            if (value.length < 2) {
                input.classList.add('form-input-error');
                if (!existingError) {
                    const errorMsg = document.createElement('div');
                    errorMsg.id = errorId;
                    errorMsg.className = 'form-error-message';
                    errorMsg.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é</span>
                    `;
                    input.parentNode.appendChild(errorMsg);
                }
                return false;
            } else {
                input.classList.remove('form-input-error');
                if (existingError) existingError.remove();
                return true;
            }
        }

        function validateEmail(input) {
            const value = input.value.trim();
            const errorId = 'email-error';
            let existingError = document.getElementById(errorId);
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!emailRegex.test(value)) {
                input.classList.add('form-input-error');
                if (!existingError) {
                    const errorMsg = document.createElement('div');
                    errorMsg.id = errorId;
                    errorMsg.className = 'form-error-message';
                    errorMsg.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</span>
                    `;
                    input.parentNode.appendChild(errorMsg);
                }
                return false;
            } else {
                input.classList.remove('form-input-error');
                if (existingError) existingError.remove();
                return true;
            }
        }

        function validatePhone(input) {
            const value = input.value.trim();
            const errorId = 'phone-error';
            let existingError = document.getElementById(errorId);
            const phoneRegex = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;

            if (!phoneRegex.test(value) || value.length < 8) {
                input.classList.add('form-input-error');
                if (!existingError) {
                    const errorMsg = document.createElement('div');
                    errorMsg.id = errorId;
                    errorMsg.className = 'form-error-message';
                    errorMsg.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span>–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</span>
                    `;
                    input.parentNode.appendChild(errorMsg);
                }
                return false;
            } else {
                input.classList.remove('form-input-error');
                if (existingError) existingError.remove();
                return true;
            }
        }

        function setupFormValidation() {
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');

            nameInput.addEventListener('blur', () => validateName(nameInput));
            nameInput.addEventListener('input', () => {
                if (nameInput.classList.contains('form-input-error')) {
                    validateName(nameInput);
                }
            });

            emailInput.addEventListener('blur', () => validateEmail(emailInput));
            emailInput.addEventListener('input', () => {
                if (emailInput.classList.contains('form-input-error')) {
                    validateEmail(emailInput);
                }
            });

            phoneInput.addEventListener('blur', () => validatePhone(phoneInput));
            phoneInput.addEventListener('input', () => {
                if (phoneInput.classList.contains('form-input-error')) {
                    validatePhone(phoneInput);
                }
            });
        }

        function saveCustomerData(name, email, phone, allergies = '') {
            try {
                const data = { name, email, phone, allergies };
                localStorage.setItem('customerData', JSON.stringify(data));
            } catch (e) {
                console.error('Error saving customer data:', e);
            }
        }

        function loadCustomerData() {
            const savedData = localStorage.getItem('customerData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.name) document.getElementById('name').value = data.name;
                    if (data.email) document.getElementById('email').value = data.email;
                    if (data.phone) document.getElementById('phone').value = data.phone;
                    if (data.allergies) document.getElementById('allergies').value = data.allergies;
                } catch (e) {
                    console.error('Error loading customer data:', e);
                }
            }
        }

        async function showMyBookings() {
            let savedEmail = '';
            const savedData = localStorage.getItem('customerData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    savedEmail = data.email || '';
                } catch (e) {
                    console.error('Error loading saved email:', e);
                }
            }

            const email = prompt(t('mybookings_enter_email'), savedEmail);
            if (!email) return;

            try {
                const response = await fetch(`${API_URL}/bookings/email/${encodeURIComponent(email)}`);
                if (!response.ok) {
                    throw new Error('Failed to load bookings');
                }

                const bookings = await response.json();

                if (bookings.length === 0) {
                    alert(t('mybookings_none'));
                    return;
                }

                let message = t('mybookings_title') + ':\n\n';
                bookings.forEach(b => {
                    message += `#${b.id} - ${b.className}\n`;
                    message += `${t('booking_date')}: ${formatDate(b.date)} ${t('booking_time')} ${b.time}\n`;
                    message += `${t('booking_participants')}: ${b.participants}\n`;
                    message += `${t('booking_price')}: ${b.status === 'confirmed' ? t('mybookings_confirmed') : t('mybookings_cancelled')}\n\n`;
                });

                alert(message);
            } catch (error) {
                console.error('Error loading bookings:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
            }
        }

        function setupFocusTrap(modal) {
            const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
            focusableElements = modal.querySelectorAll(focusableSelectors);
            firstFocusableElement = focusableElements[0];
            lastFocusableElement = focusableElements[focusableElements.length - 1];

            modal.addEventListener('keydown', handleFocusTrap);

            setTimeout(() => {
                if (firstFocusableElement) {
                    firstFocusableElement.focus();
                }
            }, 100);
        }

        function removeFocusTrap(modal) {
            modal.removeEventListener('keydown', handleFocusTrap);

            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }

        function handleFocusTrap(e) {
            if (e.key !== 'Tab') return;

            if (e.shiftKey) {
                if (document.activeElement === firstFocusableElement) {
                    e.preventDefault();
                    lastFocusableElement.focus();
                }
            } else {
                if (document.activeElement === lastFocusableElement) {
                    e.preventDefault();
                    firstFocusableElement.focus();
                }
            }
        }

        function initScrollAnimations() {
            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -100px 0px',
                threshold: 0.1
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('.scroll-reveal').forEach(el => {
                observer.observe(el);
            });
        }

        // Make functions globally accessible for inline onclick handlers
        window.openBookingModal = openBookingModal;
        window.closeModal = closeModal;
        window.updateBookingSummary = updateBookingSummary;
        window.showMyBookings = showMyBookings;
        window.togglePaymentType = togglePaymentType;

        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');

            const isNameValid = validateName(nameInput);
            const isEmailValid = validateEmail(emailInput);
            const isPhoneValid = validatePhone(phoneInput);

            if (!isNameValid || !isEmailValid || !isPhoneValid) {
                const firstError = document.querySelector('.form-input-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = true;
            const originalButtonContent = submitButton.innerHTML;
            submitButton.innerHTML = `
                <svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M12 2 A 10 10 0 0 1 22 12" opacity="0.75"/>
                </svg>
                <span>–û–±—Ä–∞–±–æ—Ç–∫–∞...</span>
            `;

            const name = nameInput.value;
            const email = emailInput.value;
            const phone = phoneInput.value;
            const allergies = document.getElementById('allergies').value;
            const participants = parseInt(document.getElementById('participants').value);
            const paymentType = document.getElementById('paymentType').value;

            try {
                if (!clientSecret) {
                    const response = await fetch(`${API_URL}/create-payment-intent`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            classId: selectedClass.id,
                            participants: participants,
                            email: email,
                            name: name,
                            paymentType: paymentType
                        }),
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to create payment');
                    }

                    const data = await response.json();
                    clientSecret = data.clientSecret;
                }

                const { paymentIntent, error: stripeError } = await stripe.confirmCardPayment(
                    clientSecret,
                    {
                        payment_method: {
                            card: cardElement,
                            billing_details: {
                                name: name,
                                email: email,
                                phone: phone,
                            },
                        },
                    }
                );

                if (stripeError) {
                    throw new Error(stripeError.message);
                }

                const confirmResponse = await fetch(`${API_URL}/confirm-booking`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentIntentId: paymentIntent.id,
                        classId: selectedClass.id,
                        name: name,
                        email: email,
                        phone: phone,
                        participants: participants,
                        paymentType: paymentType
                    }),
                });

                if (!confirmResponse.ok) {
                    const error = await confirmResponse.json();
                    throw new Error(error.error || 'Failed to confirm booking');
                }

                const booking = await confirmResponse.json();

                saveCustomerData(name, email, phone, allergies);

                await loadClasses();

                const currentLang = window.currentLang || 'ru';
                const title = typeof selectedClass.title === 'object'
                    ? selectedClass.title[currentLang] || selectedClass.title.ru
                    : selectedClass.title;

                document.getElementById('successMessage').innerHTML = `
                    <div class="success-message">
                        <div class="success-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" fill="var(--color-success)" stroke="var(--color-success)"/>
                                <polyline points="8 12 11 15 16 9" stroke="white" stroke-width="3"/>
                            </svg>
                        </div>
                        <h3>${t('msg_success')}</h3>
                        <p>${t('msg_booking_success')}</p>
                        <p>${name}!</p>
                        <p>"${title}"</p>
                        <p>${t('booking_participants')}: ${participants}</p>
                        <p>${email}</p>
                        <p style="margin-top: 15px; font-size: 0.9em;">ID: #${booking.booking.id}</p>
                    </div>
                `;
                document.getElementById('successMessage').style.display = 'block';
                document.getElementById('bookingForm').style.display = 'none';

                setTimeout(() => {
                    closeModal();
                    document.getElementById('bookingForm').style.display = 'block';
                }, 4000);

            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('card-errors').textContent = error.message;
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonContent;
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('bookingModal');
                if (modal.style.display === 'flex') {
                    closeModal();
                }
            }
        });

        document.addEventListener('languageChanged', () => {
            renderClasses();
            if (selectedClass) {
                updateBookingSummary();
            }
        });

        (async function init() {
            initScrollAnimations();
            const loaded = await loadConfig();
            if (loaded) {
                loadClasses();
            }
            const savedLang = getCurrentLanguage();
            setLanguage(savedLang);
        })();
    </script>
</body>
</html>
